0e4d3f9c5396635d2577dfd5ce5b5386
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateRandomBoard = generateRandomBoard;
const board_1 = require("../board/");
const exceptions_1 = require("../exceptions");
const gameManager_1 = require("../exceptions/gameManager");
const assertions_1 = require("../utils/assertions");
const _1 = require("./");
const HeroEntity_1 = require("./hero/HeroEntity");
function generateRandomBoard(width, height, wallProbability) {
    let map = [];
    for (let y = 0; y < height; y++) {
        map[y] = new Array(width);
        for (let x = 0; x < width; x++) {
            map[y][x] = Math.random() < wallProbability ? board_1.TileType.Wall : board_1.TileType.Floor;
        }
    }
    return map;
}
class GameManager {
    // Whether the client is currently animating.
    // TODO : Use a buffer !
    _board;
    _turnIndex = 0;
    _teams = [];
    _entities = {};
    constructor(dto) {
        this._board = new board_1.Board(dto.tiles);
    }
    pushTeam(team) {
        if (this._teams.find((t) => t.uuid === team.uuid)) {
            throw new exceptions_1.TeamAlreadyExistsException(team);
        }
        if (team.entities.length > 0) {
            throw new exceptions_1.TeamNotEmptyException(team);
        }
        this._teams.push(team);
    }
    pushEntity(entity, coordinate) {
        if (!entity.team)
            throw new gameManager_1.InvalidEntityException(entity);
        const TEAM = this._teams.find((t) => t.uuid === entity.team?.uuid);
        if (!TEAM)
            throw new exceptions_1.TeamNotExistsException(TEAM);
        this._board.pushEntity(entity, coordinate);
        TEAM.pushEntity(entity);
    }
    moveEntity(entity, path) {
        if (!Object.hasOwn(entity.resources, _1.ResourceType.STAMINA))
            throw new gameManager_1.InvalidEntityException(entity);
        while (path.length > 0) {
            let coordinate = path.pop();
            this.moveEntityTo(entity, coordinate);
        }
    }
    moveEntityTo(entity, coordinate) {
        this._board.moveEntity(entity, coordinate);
        entity.resources[_1.ResourceType.STAMINA] += this._board.getTile(coordinate).movementCost;
    }
    deleteEntity(entity) {
        this._teams.find((t) => t.entities.find((e) => e.uuid === entity.uuid)).deleteEntity(entity);
        this._board.deleteEntity(entity);
    }
    castSpell(spell, coordinate) {
        const CASTER = this.currentHero;
        return spell.cast(CASTER, this.board.getEntityCoordinate(CASTER), coordinate, this.board);
    }
    nextTurn() {
        // TODO : Better Event Handler
        (0, assertions_1.notUndefined)(this.currentHero).onEndTurn();
        this._turnIndex++;
    }
    get currentEntity() {
        if (this._teams.length <= 0)
            return undefined;
        const TEAM_INDEX = this._turnIndex % this._teams.length;
        if (this._teams[TEAM_INDEX].entities.length <= 0)
            return undefined;
        const HERO_INDEX = Math.floor((this._turnIndex / this._teams.length) % this._teams[TEAM_INDEX].entities.length);
        return this._teams[TEAM_INDEX].entities[HERO_INDEX];
    }
    get currentHero() {
        const currentEntity = this.currentEntity;
        if ((0, HeroEntity_1.isHeroEntity)(currentEntity))
            return currentEntity;
    }
    get board() {
        return this._board;
    }
}
exports.default = GameManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUMzQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDcEIsQ0FBQztJQUVELElBQUksYUFBYTtRQUNmLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQztZQUFFLE9BQU8sU0FBUyxDQUFDO1FBQzlDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDeEQsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLElBQUksQ0FBQztZQUFFLE9BQU8sU0FBUyxDQUFDO1FBQ25FLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDaEgsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsSUFBSSxXQUFXO1FBQ2IsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQztRQUN6QyxJQUFJLElBQUEseUJBQVksRUFBQyxhQUFhLENBQUM7WUFBRSxPQUFPLGFBQWEsQ0FBQztJQUN4RCxDQUFDO0lBRUQsSUFBSSxLQUFLO1FBQ1AsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3JCLENBQUM7Q0FDRjtBQTlFRCw4QkE4RUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXEdpdGh1YlxcQWxnb29cXGNvcmVcXHNyY1xcZ2FtZVxcR2FtZU1hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBDb29yZGluYXRlLCBTaW1wbGVDb29yZGluYXRlIH0gZnJvbSAnLi4vYm9hcmQvJztcbmltcG9ydCB7IEJvYXJkLCBFbnRpdHksIFRpbGVUeXBlIH0gZnJvbSAnLi4vYm9hcmQvJztcbmltcG9ydCB0eXBlIHsgR2FtZU1hbmFnZXJEVE8gfSBmcm9tICcuLi9kdG8vR2FtZU1hbmFnZXJEVE8nO1xuaW1wb3J0IHsgVGVhbUFscmVhZHlFeGlzdHNFeGNlcHRpb24sIFRlYW1Ob3RFbXB0eUV4Y2VwdGlvbiwgVGVhbU5vdEV4aXN0c0V4Y2VwdGlvbiB9IGZyb20gJy4uL2V4Y2VwdGlvbnMnO1xuaW1wb3J0IHsgSW52YWxpZEVudGl0eUV4Y2VwdGlvbiB9IGZyb20gJy4uL2V4Y2VwdGlvbnMvZ2FtZU1hbmFnZXInO1xuaW1wb3J0IHsgQWN0aW9uUmVzdW1lIH0gZnJvbSAnLi4vc3RyYXRlZ3knO1xuaW1wb3J0IHsgbm90VW5kZWZpbmVkIH0gZnJvbSAnLi4vdXRpbHMvYXNzZXJ0aW9ucyc7XG5pbXBvcnQgdHlwZSB7IFJlc291cmNlcywgU3BlbGwsIFN0YW5kYXJkUmVzb3VyY2VzIH0gZnJvbSAnLi8nO1xuaW1wb3J0IHsgSGVyb0VudGl0eSwgUmVzb3VyY2VUeXBlLCBUZWFtIH0gZnJvbSAnLi8nO1xuaW1wb3J0IHsgaXNIZXJvRW50aXR5IH0gZnJvbSAnLi9oZXJvL0hlcm9FbnRpdHknO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVSYW5kb21Cb2FyZCh3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgd2FsbFByb2JhYmlsaXR5OiBudW1iZXIpOiBUaWxlVHlwZVtdW10ge1xuICBsZXQgbWFwOiBUaWxlVHlwZVtdW10gPSBbXTtcbiAgZm9yIChsZXQgeSA9IDA7IHkgPCBoZWlnaHQ7IHkrKykge1xuICAgIG1hcFt5XSA9IG5ldyBBcnJheSh3aWR0aCk7XG4gICAgZm9yIChsZXQgeCA9IDA7IHggPCB3aWR0aDsgeCsrKSB7XG4gICAgICBtYXBbeV1beF0gPSBNYXRoLnJhbmRvbSgpIDwgd2FsbFByb2JhYmlsaXR5ID8gVGlsZVR5cGUuV2FsbCA6IFRpbGVUeXBlLkZsb29yO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBtYXA7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEdhbWVNYW5hZ2VyIHtcbiAgLy8gV2hldGhlciB0aGUgY2xpZW50IGlzIGN1cnJlbnRseSBhbmltYXRpbmcuXG4gIC8vIFRPRE8gOiBVc2UgYSBidWZmZXIgIVxuICBwcml2YXRlIHJlYWRvbmx5IF9ib2FyZDogQm9hcmQ7XG4gIHByaXZhdGUgX3R1cm5JbmRleDogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBfdGVhbXM6IFRlYW1bXSA9IFtdO1xuICBwcml2YXRlIF9lbnRpdGllczogeyBba2V5IGluIHN0cmluZ106IEVudGl0eTxSZXNvdXJjZXM+IH0gPSB7fTtcblxuICBjb25zdHJ1Y3RvcihkdG86IEdhbWVNYW5hZ2VyRFRPKSB7XG4gICAgdGhpcy5fYm9hcmQgPSBuZXcgQm9hcmQoZHRvLnRpbGVzKTtcbiAgfVxuXG4gIHB1c2hUZWFtKHRlYW06IFRlYW0pOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fdGVhbXMuZmluZCgodCkgPT4gdC51dWlkID09PSB0ZWFtLnV1aWQpKSB7XG4gICAgICB0aHJvdyBuZXcgVGVhbUFscmVhZHlFeGlzdHNFeGNlcHRpb24odGVhbSk7XG4gICAgfVxuICAgIGlmICh0ZWFtLmVudGl0aWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBUZWFtTm90RW1wdHlFeGNlcHRpb24odGVhbSk7XG4gICAgfVxuICAgIHRoaXMuX3RlYW1zLnB1c2godGVhbSk7XG4gIH1cblxuICBwdXNoRW50aXR5KGVudGl0eTogRW50aXR5PFJlc291cmNlcz4sIGNvb3JkaW5hdGU6IENvb3JkaW5hdGUpOiB2b2lkIHtcbiAgICBpZiAoIWVudGl0eS50ZWFtKSB0aHJvdyBuZXcgSW52YWxpZEVudGl0eUV4Y2VwdGlvbihlbnRpdHkpO1xuXG4gICAgY29uc3QgVEVBTSA9IHRoaXMuX3RlYW1zLmZpbmQoKHQpID0+IHQudXVpZCA9PT0gZW50aXR5LnRlYW0/LnV1aWQpITtcbiAgICBpZiAoIVRFQU0pIHRocm93IG5ldyBUZWFtTm90RXhpc3RzRXhjZXB0aW9uKFRFQU0pO1xuXG4gICAgdGhpcy5fYm9hcmQucHVzaEVudGl0eShlbnRpdHksIGNvb3JkaW5hdGUpO1xuICAgIFRFQU0ucHVzaEVudGl0eShlbnRpdHkpO1xuICB9XG5cbiAgbW92ZUVudGl0eShlbnRpdHk6IEVudGl0eTxSZXNvdXJjZXM+LCBwYXRoOiBTaW1wbGVDb29yZGluYXRlW10pOiB2b2lkIHtcbiAgICBpZiAoIU9iamVjdC5oYXNPd24oZW50aXR5LnJlc291cmNlcywgUmVzb3VyY2VUeXBlLlNUQU1JTkEpKSB0aHJvdyBuZXcgSW52YWxpZEVudGl0eUV4Y2VwdGlvbihlbnRpdHkpO1xuXG4gICAgd2hpbGUgKHBhdGgubGVuZ3RoID4gMCkge1xuICAgICAgbGV0IGNvb3JkaW5hdGUgPSBwYXRoLnBvcCgpITtcbiAgICAgIHRoaXMubW92ZUVudGl0eVRvKGVudGl0eSwgY29vcmRpbmF0ZSk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIG1vdmVFbnRpdHlUbyhlbnRpdHk6IEVudGl0eTxSZXNvdXJjZXM+LCBjb29yZGluYXRlOiBTaW1wbGVDb29yZGluYXRlKTogdm9pZCB7XG4gICAgdGhpcy5fYm9hcmQubW92ZUVudGl0eShlbnRpdHksIGNvb3JkaW5hdGUpO1xuICAgIGVudGl0eS5yZXNvdXJjZXNbUmVzb3VyY2VUeXBlLlNUQU1JTkFdISArPSB0aGlzLl9ib2FyZC5nZXRUaWxlKGNvb3JkaW5hdGUpLm1vdmVtZW50Q29zdDtcbiAgfVxuXG4gIGRlbGV0ZUVudGl0eShlbnRpdHk6IEVudGl0eTxSZXNvdXJjZXM+KTogdm9pZCB7XG4gICAgdGhpcy5fdGVhbXMuZmluZCgodCkgPT4gdC5lbnRpdGllcy5maW5kKChlKSA9PiBlLnV1aWQgPT09IGVudGl0eS51dWlkKSEpIS5kZWxldGVFbnRpdHkoZW50aXR5KTtcbiAgICB0aGlzLl9ib2FyZC5kZWxldGVFbnRpdHkoZW50aXR5KTtcbiAgfVxuXG4gIGNhc3RTcGVsbChzcGVsbDogU3BlbGwsIGNvb3JkaW5hdGU6IFNpbXBsZUNvb3JkaW5hdGUpOiBBY3Rpb25SZXN1bWVbXSB7XG4gICAgY29uc3QgQ0FTVEVSOiBFbnRpdHk8UmVzb3VyY2VzPiA9IHRoaXMuY3VycmVudEhlcm8hO1xuICAgIHJldHVybiBzcGVsbC5jYXN0KENBU1RFUiwgdGhpcy5ib2FyZC5nZXRFbnRpdHlDb29yZGluYXRlKENBU1RFUiksIGNvb3JkaW5hdGUsIHRoaXMuYm9hcmQpO1xuICB9XG5cbiAgbmV4dFR1cm4oKTogdm9pZCB7XG4gICAgLy8gVE9ETyA6IEJldHRlciBFdmVudCBIYW5kbGVyXG4gICAgbm90VW5kZWZpbmVkKHRoaXMuY3VycmVudEhlcm8pLm9uRW5kVHVybigpO1xuICAgIHRoaXMuX3R1cm5JbmRleCsrO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRFbnRpdHkoKTogRW50aXR5PFJlc291cmNlcz4gfCB1bmRlZmluZWQge1xuICAgIGlmICh0aGlzLl90ZWFtcy5sZW5ndGggPD0gMCkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICBjb25zdCBURUFNX0lOREVYID0gdGhpcy5fdHVybkluZGV4ICUgdGhpcy5fdGVhbXMubGVuZ3RoO1xuICAgIGlmICh0aGlzLl90ZWFtc1tURUFNX0lOREVYXS5lbnRpdGllcy5sZW5ndGggPD0gMCkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICBjb25zdCBIRVJPX0lOREVYID0gTWF0aC5mbG9vcigodGhpcy5fdHVybkluZGV4IC8gdGhpcy5fdGVhbXMubGVuZ3RoKSAlIHRoaXMuX3RlYW1zW1RFQU1fSU5ERVhdLmVudGl0aWVzLmxlbmd0aCk7XG4gICAgcmV0dXJuIHRoaXMuX3RlYW1zW1RFQU1fSU5ERVhdLmVudGl0aWVzW0hFUk9fSU5ERVhdO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRIZXJvKCk6IEhlcm9FbnRpdHkgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGN1cnJlbnRFbnRpdHkgPSB0aGlzLmN1cnJlbnRFbnRpdHk7XG4gICAgaWYgKGlzSGVyb0VudGl0eShjdXJyZW50RW50aXR5KSkgcmV0dXJuIGN1cnJlbnRFbnRpdHk7XG4gIH1cblxuICBnZXQgYm9hcmQoKTogQm9hcmQge1xuICAgIHJldHVybiB0aGlzLl9ib2FyZDtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9